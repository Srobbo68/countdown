<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Nexus Countdown</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap');

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Montserrat', sans-serif;
      background: #f4f4f4;
      overflow: hidden;
      display: flex;
      flex-direction: row;
      height: 100vh;
    }

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .time-box {
      width: 100%;
      max-width: 800px;
      text-align: center;
      margin-bottom: 40px;
    }

    .time-box h2 {
      font-size: 36px;
      margin-bottom: 10px;
      color: #0057A0;
    }

    .time-value {
      font-size: 72px;
      font-weight: bold;
      color: #0057A0;
      min-height: 88px;
    }

    .event-title-line {
      font-size: 36px;
      color: #0057A0;
      margin-bottom: 10px;
    }

    .sidebar {
      width: 350px;
      background: #fff;
      padding: 20px;
      border-left: 2px solid #ccc;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .sidebar h2 {
      font-size: 36px;
      color: #0057A0;
      margin-bottom: 10px;
    }

    .event {
      margin-bottom: 15px;
    }

    .event-title {
      font-size: 26px;
      font-weight: bold;
      color: #0057A0;
    }

    .event-time {
      font-size: 26px;
      color: #333;
    }

    .filter-buttons {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .filter-buttons button {
      flex: 1;
      margin: 0 5px;
      padding: 8px 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      background-color: #eee;
      border: none;
      border-radius: 4px;
    }

    .filter-buttons button.active {
      background-color: #0057A0;
      color: white;
    }

    .ticker {
      position: absolute;
      bottom: 0;
      width: 100%;
      height: 50px;
      background: #ddd;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: #0057A0;
    }

    .fade {
      opacity: 0;
      transition: opacity 1s ease-in-out;
    }

    .fade.visible {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="main">
    <div class="time-box">
      <h2>Current Time</h2>
      <div id="current-time" class="time-value">--:--</div>
    </div>
    <div class="time-box">
      <div id="next-event-title" class="event-title-line">Next Session: Title</div>
      <div id="countdown" class="time-value">00h 00m 00s</div>
    </div>
  </div>
  <div class="sidebar">
    <h2>Events</h2>
    <div class="filter-buttons">
      <button onclick="setFilter('ALL')" id="btn-ALL">All</button>
      <button onclick="setFilter('G')" id="btn-G">Garage</button>
      <button onclick="setFilter('D')" id="btn-D">Driver</button>
      <button onclick="setFilter('M')" id="btn-M">Media</button>
    </div>
    <div id="event-list">Loading eventsâ€¦</div>
  </div>
  <div class="ticker">
    <img id="nexus-logo" src="NPS.png" alt="Nexus Logo" style="max-height: 150px; display: none;">
    <div id="ticker-text"></div>
  </div>
  <script>
    const API_KEY = 'AIzaSyAVtt3Q4Rm-72rjJCTgGSwJvNzgDQ7w6Qs';
    const CALENDAR_ID = 'd8573d58063057003d14a9ead801d83d0bbacf880d6fee3f9f5615e2eeb0433c@group.calendar.google.com';
    const MAX_EVENTS = 8;
    let currentFilter = 'ALL';
    let tickerIndex = 0;
    const tickerPhases = [
      () => {
        document.getElementById("nexus-logo").style.display = "block";
        document.getElementById("ticker-text").innerText = "";
      },
      () => {
        document.getElementById("nexus-logo").style.display = "none";
        document.getElementById("ticker-text").innerText = "Nexus Performance Solutions";
      },
      () => {
        document.getElementById("ticker-text").innerText = "Connecting Strategy to Peak Motorsport Performance";
      }
    ];

    function rotateTicker() {
      tickerPhases[tickerIndex % tickerPhases.length]();
      tickerIndex++;
    }

    setInterval(rotateTicker, 4000);
    rotateTicker();

    function updateTime() {
      const now = new Date();
      const options = { weekday: 'short', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
      document.getElementById("current-time").innerText = now.toLocaleString('en-AU', options);
    }
    setInterval(updateTime, 1000);
    updateTime();

    function setFilter(filter) {
      currentFilter = filter;
      document.querySelectorAll('.filter-buttons button').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`btn-${filter}`).classList.add('active');
      loadEvents();
    }

    function cleanTitle(summary) {
      return summary.replace(/^[GDM]:\s*/, '');
    }

    function loadEvents() {
      const now = new Date().toISOString();
      const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(CALENDAR_ID)}/events?key=${API_KEY}&timeMin=${now}&maxResults=20&orderBy=startTime&singleEvents=true`;
      fetch(url)
        .then(response => response.json())
        .then(data => {
          const events = (data.items || []).filter(ev => {
            if (!ev.start?.dateTime) return false;
            if (currentFilter === 'ALL') return true;
            return ev.summary?.startsWith(currentFilter + ':');
          }).slice(0, MAX_EVENTS);

          const eventList = document.getElementById("event-list");
          eventList.innerHTML = '';

          events.forEach((ev, index) => {
            const start = new Date(ev.start.dateTime);
            const end = new Date(ev.end.dateTime);
            const summary = cleanTitle(ev.summary || '');
            const day = start.toLocaleDateString('en-AU', { weekday: 'short' });
            const time = start.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false });
            const div = document.createElement('div');
            div.className = 'event';
            div.innerHTML = `<div class="event-title">${summary}</div><div class="event-time">${day} ${time}</div>`;
            eventList.appendChild(div);
            if (index === 0) updateCountdown(summary, start, end);
          });
        });
    }

    function updateCountdown(title, start, end) {
      document.getElementById("next-event-title").innerText = `Next Session: ${title}`;
      const countdown = document.getElementById("countdown");
      let phase = 'start';
      let target = start;
      const tick = () => {
        const now = new Date();
        let remaining = target.getTime() - now.getTime();
        if (remaining <= 0) {
          if (phase === 'start') {
            phase = 'end';
            target = end;
          } else {
            loadEvents();
            return;
          }
        }
        const h = Math.floor((remaining / 3600000));
        const m = Math.floor((remaining % 3600000) / 60000);
        const s = Math.floor((remaining % 60000) / 1000);
        let output = `${h > 0 ? h + 'h ' : ''}${m > 0 ? m + 'm ' : ''}${s}s`;
        countdown.innerText = `${phase === 'start' ? 'Start:' : 'End:'} ${output}`;
      };
      tick();
      setInterval(tick, 1000);
    }

    setFilter('ALL');
  </script>
</body>
</html>
